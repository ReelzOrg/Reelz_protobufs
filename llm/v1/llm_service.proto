syntax = "proto3";

package llm.v1; // Must match directory structure llm/v1/

option go_package = "llm/v1;llmv1";

/* =========================== TOP-LEVEL SERVICE =========================== */
service LLMService {
	//Buf enforces a strict convention: rpc MethodName(MethodNameRequest) returns (MethodNameResponse)
  rpc LLMChat(LLMChatRequest) returns (stream LLMChatResponse);
  
  // NEW: Check if uploaded files are ready for querying
  rpc CheckFileStatus(CheckFileStatusRequest) returns (CheckFileStatusResponse);
  
  // NEW: Get user's chat history
  rpc GetChatHistory(GetChatHistoryRequest) returns (GetChatHistoryResponse);
}

/* =========================== REQUEST =========================== */
message LLMChatRequest {
  string request_id = 1;
  string user_id = 2;
  string session_id = 3;
  repeated ContentBlock prompt = 4;
  
  // NEW: Context management hints
  ContextOptions context_options = 5;
  
  // NEW: Model preferences (optional override)
  ModelPreferences model_prefs = 6;
}

message ContextOptions {
  // Max tokens to use from history
  int32 max_history_tokens = 1;
  
  // Whether to use RAG retrieval
  bool enable_retrieval = 2;
  
  // Max chunks to retrieve from vector DB
  int32 max_retrieval_chunks = 3;
  
  // Whether to wait for file processing (vs return immediately)
  bool wait_for_files = 4;
}

message ModelPreferences {
  // Force a specific model (e.g., "llama3-70b", "llava-1.6")
  string model_override = 1;
  
  // Routing strategy: "auto", "fast", "quality"
  string routing_strategy = 2;
}

/* =========================== INPUT =========================== */
message ContentBlock {
  string mime_type = 1;
  oneof data {
    string text = 2;
    string uri = 3;  // S3/presigned URL
  }
  map<string, string> metadata = 4;
  
  // NEW: For large files, client can provide processing hints
  ProcessingHints hints = 5;
}

message ProcessingHints {
  // For videos: which segments to focus on (seconds)
  repeated TimeRange time_ranges = 1;
  
  // For documents: specific pages
  repeated int32 page_numbers = 2;
  
  // Priority level (higher = process faster)
  int32 priority = 3;
}

message TimeRange {
  float start_seconds = 1;
  float end_seconds = 2;
}

/* =========================== STREAMING EVENTS =========================== */
message LLMChatResponse {
  string request_id = 1;
  int64 sequence = 2;
  oneof event {
    StreamStart start = 10;
    ModelSelected model_selected = 11;
    
    // NEW: File processing status updates
    FileProcessingStatus file_status = 12;
    
    TextToken token = 20;
    TextMessage message = 21;
    
    ArtifactStarted artifact_started = 30;
    ArtifactChunk artifact_chunk = 31;
    ArtifactCompleted artifact_completed = 32;
    
    ToolCall tool_call = 40;
    ToolResult tool_result = 41;
    
    Citation citation = 50;
    
    ExecutionSummary summary = 80;
    StreamEnd end = 90;
    ErrorEvent error = 99;
  }
}

// NEW: Real-time file processing updates
message FileProcessingStatus {
  string file_id = 1;
  string filename = 2;
  FileStatus status = 3;
  float progress_percent = 4;
  string message = 5;  // e.g., "Extracting keyframes..."
}

enum FileStatus {
  FILE_STATUS_UNSPECIFIED = 0;
  FILE_STATUS_UPLOADING = 1;
  FILE_STATUS_QUEUED = 2;
  FILE_STATUS_PROCESSING = 3;
  FILE_STATUS_READY = 4;
  FILE_STATUS_FAILED = 5;
}

/* =========================== SUMMARY =========================== */
message ExecutionSummary {
  repeated ModelUsage model_usage = 1;
  int64 total_input_tokens = 2;
  int64 total_output_tokens = 3;
  int64 total_tokens = 4;
  string currency = 5;
  double estimated_cost = 6;
  
  // NEW: Processing stats
  int64 files_processed = 7;
  int64 retrieval_chunks_used = 8;
}

message ModelUsage {
  string model_name = 1;
  int64 input_tokens = 2;
  int64 output_tokens = 3;
  int64 total_tokens = 4;
  map<string, string> metadata = 5;
}

/* =========================== STREAM LIFECYCLE =========================== */
message StreamStart {
  string timestamp = 1;
}

message StreamEnd {
  string timestamp = 1;
  FinishReason finish_reason = 2;
}

enum FinishReason {
  FINISH_REASON_UNSPECIFIED = 0;
  FINISH_REASON_COMPLETED = 1;
  FINISH_REASON_CANCELLED = 2;
  FINISH_REASON_ERROR = 3;
  FINISH_REASON_CONTEXT_LENGTH_EXCEEDED = 4;
}

/* =========================== MODEL ROUTING =========================== */
message ModelSelected {
  string model_name = 1;
  map<string, string> parameters = 2;
  string routing_reason = 3;  // e.g., "complex query with images"
}

/* =========================== TEXT OUTPUT =========================== */
message TextToken {
  string text = 1;
}

message TextMessage {
  string text = 1;
}

/* =========================== ARTIFACTS =========================== */
message ArtifactStarted {
  string artifact_id = 1;
  ArtifactType type = 2;
  string mime_type = 3;
}

message ArtifactChunk {
  string artifact_id = 1;
  oneof data {
    bytes inline_bytes = 2;
    string uri = 3;
  }
}

message ArtifactCompleted {
  string artifact_id = 1;
  string final_uri = 2;
  map<string, string> metadata = 3;
}

enum ArtifactType {
  ARTIFACT_TYPE_UNSPECIFIED = 0;
  ARTIFACT_TYPE_IMAGE = 1;
  ARTIFACT_TYPE_AUDIO = 2;
  ARTIFACT_TYPE_VIDEO = 3;
  ARTIFACT_TYPE_DOCUMENT = 4;
  ARTIFACT_TYPE_CODE = 5;
}

/* =========================== TOOLS =========================== */
message ToolCall {
  string tool_name = 1;
  string call_id = 2;
  string input_json = 3;
}

message ToolResult {
  string call_id = 1;
  string output_json = 2;
  bool success = 3;
}

/* =========================== RETRIEVAL / CITATIONS =========================== */
message Citation {
  string citation_id = 1;
  string source_uri = 2;
  string excerpt = 3;
  float relevance_score = 4;  // NEW
}

/* =========================== FILE STATUS CHECK =========================== */
message CheckFileStatusRequest {
  repeated string file_ids = 1;
}

message CheckFileStatusResponse {
  repeated FileInfo files = 1;
}

message FileInfo {
  string file_id = 1;
  FileStatus status = 2;
  string s3_uri = 3;
  int64 size_bytes = 4;
  string mime_type = 5;
  float processing_progress = 6;
}

/* =========================== CHAT HISTORY =========================== */
message ChatHistoryRequest {
  string user_id = 1;
  string session_id = 2;
  int32 max_messages = 3;
}

message ChatHistoryResponse {
  repeated ChatMessage messages = 1;
}

message ChatMessage {
  string message_id = 1;
  string role = 2;  // "user" or "assistant"
  string content = 3;
  string timestamp = 4;
  repeated string file_ids = 5;
}

/* =========================== ERRORS =========================== */
message ErrorEvent {
  string code = 1;
  string message = 2;
  bool recoverable = 3;
  map<string, string> details = 4;  // NEW: structured error info
}